<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Club Details - Hub Connect</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <header>
    <div class="header-container">
      <a href="/" class="logo">
        HUB CONNECT
      </a>
      
      <div class="header-right">
        <nav id="loggedInNav" class="header-nav hidden">
          <a href="clubs.html">
            <button class="view-clubs-btn">
              View Other Clubs
            </button>
          </a>
          <a href="events.html">
            <button class="view-events-btn">View All Events</button>
          </a>

          <a href="profile.html" class="user-profile">
            <div class="user-info">
              <p class="user-name" id="headerUserName">John Doe</p>
              <p class="user-email" id="headerUserEmail">john@email.com</p>
            </div>
            <div class="user-avatar" id="headerUserAvatar">JD</div>
          </a>
          <button id="logoutButton" class="btn btn-secondary">Logout</button>
        </nav>

        <button id="loginButton" class="btn btn-primary">
          Login
        </button>
      </div>
    </header>

  <main class="container">
    <a href="profile.html" style="color: #2563eb; text-decoration: none; margin-bottom: 16px; display: inline-block;">‚Üê Back to Profile</a>
    
    <div id="clubDetailContent" style="display: none;">
      <div class="card" style="max-width: 800px; margin: 0 auto;">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
          <div id="clubIcon" class="club-icon" style="width: 80px; height: 80px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 36px;"></div>
          <div>
            <h1 id="clubName" style="font-size: 28px; font-weight: 700; margin: 0;"></h1>
            <p id="clubCategory" style="color: gray; margin: 4px 0; font-size: 16px;"></p>
            <span id="userRoleBadge" class="tag" style="display: inline-block; margin-top: 8px;"></span>
          </div>
        </div>

        <div id="viewOnlyMode" style="display: none;">
          <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; font-size: 16px;">Club Description</h3>
            <p id="clubDescriptionView" style="margin: 0; line-height: 1.6;"></p>
          </div>
          
          <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; font-size: 16px;">Club Information</h3>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li><strong>Category:</strong> <span id="clubCategoryView"></span></li>
              <li><strong>Members:</strong> <span id="clubMembersView">-</span></li>
              <li><strong>Founded:</strong> <span id="clubFoundedView">-</span></li>
            </ul>
          </div>

          <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
            <h3 style="margin-top: 0; font-size: 16px;">Upcoming Events</h3>
            <div id="upcomingEventsList" style="margin: 0;">
              <p style="color: gray;">Loading events...</p>
            </div>
          </div>
        </div>

        <div id="editMode" style="display: none;">
          <form id="editClubForm" style="display: flex; flex-direction: column; gap: 16px;">
            <div class="form-group">
              <label><strong>Club Name</strong></label>
              <input type="text" id="editClubName" placeholder="Enter club name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>

            <div class="form-group">
              <label><strong>Category</strong></label>
              <select id="editClubCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <option value="">Select a category</option>
                <option value="Technology">Technology</option>
                <option value="Arts">Arts</option>
                <option value="Humanities">Humanities</option>
                <option value="Science">Science</option>
                <option value="Sports">Sports</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label><strong>Description</strong></label>
              <textarea id="editClubDescription" placeholder="Enter club description" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-height: 120px; font-family: inherit;" required></textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 16px;">
              <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
              <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="loadingMessage" style="text-align: center; padding: 40px; color: gray;">
      Loading club details...
    </div>
  </main>

  <footer class="footer">
    <p>&copy; 2025 Hub Connect. All rights reserved.</p>
  </footer>

  <script src="script.js"></script>
  <script>
    // Club Detail Page Logic
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const clubId = urlParams.get('clubId');
      const mode = urlParams.get('mode'); // 'manage' or 'view'

      if (!clubId) {
        document.getElementById('loadingMessage').textContent = 'No club selected.';
        return;
      }

      try {
        const res = await fetch(`/api/clubs/${clubId}`);
        if (!res.ok) throw new Error('Failed to fetch club details');

        const club = await res.json();
        displayClubDetails(club, mode);
      } catch (error) {
        console.error('Error loading club:', error);
        document.getElementById('loadingMessage').textContent = 'Error loading club details.';
      }
    });

    function displayClubDetails(club, mode) {
      const loadingMsg = document.getElementById('loadingMessage');
      const content = document.getElementById('clubDetailContent');
      const viewOnlyMode = document.getElementById('viewOnlyMode');
      const editMode = document.getElementById('editMode');

      loadingMsg.style.display = 'none';
      content.style.display = 'block';

      // Set icon and color
      let iconBg = '#f0fdfa';
      let iconColor = '#14b8a6';
      if (club.category === 'Arts') { iconBg = '#eff6ff'; iconColor = '#2563eb'; }
      if (club.category === 'Humanities') { iconBg = '#fffbeb'; iconColor = '#d97706'; }
      if (club.category === 'Science') { iconBg = '#fff1f2'; iconColor = '#e11d48'; }

      document.getElementById('clubIcon').style.backgroundColor = iconBg;
      document.getElementById('clubIcon').style.color = iconColor;
      document.getElementById('clubIcon').textContent = club.icon_letter || club.club_name.charAt(0);

      document.getElementById('clubName').textContent = club.club_name;
      document.getElementById('clubCategory').textContent = club.category || 'General';

      // Determine if user is admin (simplified - you may need actual role checking)
      const isManageMode = mode === 'manage';
      const userRoleBadge = document.getElementById('userRoleBadge');
      userRoleBadge.textContent = isManageMode ? 'Admin' : 'Member';
      userRoleBadge.className = isManageMode ? 'tag tag-admin' : 'tag tag-member';

      if (isManageMode) {
        editMode.style.display = 'block';
        viewOnlyMode.style.display = 'none';

        // Populate edit form
        document.getElementById('editClubName').value = club.club_name;
        document.getElementById('editClubCategory').value = club.category || '';
        document.getElementById('editClubDescription').value = club.description || '';

        // Handle form submission
        document.getElementById('editClubForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const updatedData = {
            club_name: document.getElementById('editClubName').value,
            category: document.getElementById('editClubCategory').value,
            description: document.getElementById('editClubDescription').value
          };

          try {
            const updateRes = await fetch(`/api/clubs/${club.club_id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(updatedData)
            });

            if (updateRes.ok) {
              alert('Club details updated successfully!');
              window.location.href = 'profile.html';
            } else {
              alert('Failed to update club details.');
            }
          } catch (error) {
            console.error('Error updating club:', error);
            alert('Server error: ' + error.message);
          }
        });

        // Cancel button
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
          window.location.href = 'profile.html';
        });
      } else {
        viewOnlyMode.style.display = 'block';
        editMode.style.display = 'none';

        document.getElementById('clubDescriptionView').textContent = club.description || 'No description available.';
        document.getElementById('clubCategoryView').textContent = club.category || 'General';
        document.getElementById('clubMembersView').textContent = club.member_count || '-';
        document.getElementById('clubFoundedView').textContent = club.created_at ? new Date(club.created_at).toLocaleDateString() : '-';

        // Load and display upcoming events for this club
        loadClubEvents(club.club_id);
      }
    }

    async function loadClubEvents(clubId) {
      try {
        const res = await fetch('/api/events');
        if (!res.ok) throw new Error('Failed to fetch events');

        const allEvents = await res.json();
        const clubEvents = allEvents.filter(event => event.club_id == clubId);

        const eventsList = document.getElementById('upcomingEventsList');
        eventsList.innerHTML = '';

        if (clubEvents.length === 0) {
          eventsList.innerHTML = '<p style="color: gray;">No upcoming events for this club.</p>';
          return;
        }

        clubEvents.forEach(event => {
          const eventDate = new Date(event.event_date);
          const dateStr = eventDate.toLocaleDateString();
          const timeStr = event.event_time || 'TBD';
          const location = event.location || 'TBD';
          const title = event.event_title || 'Untitled Event';
          const description = event.description || 'No description provided.';

          const eventCard = document.createElement('div');
          eventCard.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px;';
          eventCard.innerHTML = `
            <h4 style="margin: 0 0 8px 0; font-size: 15px; font-weight: 600;">${title}</h4>
            <p style="margin: 0 0 4px 0; font-size: 13px; color: #666;"><strong>Date:</strong> ${dateStr} at ${timeStr}</p>
            <p style="margin: 0 0 4px 0; font-size: 13px; color: #666;"><strong>Location:</strong> ${location}</p>
            <p style="margin: 0; font-size: 13px; color: #555; line-height: 1.4;">${description}</p>
          `;
          eventsList.appendChild(eventCard);
        });
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('upcomingEventsList').innerHTML = '<p style="color: red;">Error loading events.</p>';
      }
    }
  </script>

</body>
</html>
